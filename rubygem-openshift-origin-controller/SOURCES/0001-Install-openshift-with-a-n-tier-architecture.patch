From cf80a414546686b9a1960477ba7b5023a7251002 Mon Sep 17 00:00:00 2001
From: Filirom1 <filirom1@gmail.com>
Date: Wed, 12 Jun 2013 14:59:22 +0000
Subject: [PATCH] Install openshift with a n-tier architecture

---
 controller/app/models/application.rb               |   28 ++++++-
 6 files changed, 127 insertions(+), 2 deletions(-)
 create mode 100644 documentation/install_origin_with_a_n_tier_architecture.md

diff --git a/app/models/application.rb b/app/models/application.rb
index d1628ac..89428c8 100644
--- a/app/models/application.rb
+++ b/app/models/application.rb
@@ -1,4 +1,5 @@
 require 'matrix'
+require 'resolv'

 class Matrix
   def []=(i, j, x)
@@ -668,6 +669,30 @@
   end

   ##
+  # Returns the IP address for the primary application gear
+  # @return [String]
+  def resolveIp(domain=nil)
+    begin
+      return Resolv.getaddress(fqdn(domain))
+    rescue Exception => e
+      return fqdn(domain)
+    end
+  end
+
+  ##
+  # Returns the fqdn for the primary application gear if config SSH_FQDN is true,
+  # otherwise returns the IP address
+  # @return [String]
+  def fqdnOrIp(domain=nil, gear_name = nil)
+    if Rails.configuration.openshift[:ssh_fqdn] == "true"
+      fqdn(domain, gear_name)
+    else
+      resolveIp(domain)
+    end
+  end
+
+
+  ##
   # Returns the SSH URI for an application gear (unless specified, the primary)
   # @return [String]
   def ssh_uri(domain=nil, gear_uuid=nil)
@@ -675,12 +700,12 @@
       if gear_uuid # specific gear_uuid requested
         if group_instance.gears.where(uuid: gear_uuid).count > 0
           gear = group_instance.gears.find_by(uuid: gear_uuid)
-          return "#{gear_uuid}@#{fqdn(domain,gear.name)}"
+          return "#{gear_uuid}@#{fqdnOrIp(domain,gear.name)}"
         end
       elsif group_instance.gears.where(app_dns: true).count > 0
         # get the gear_uuid of head gear
         gear = group_instance.gears.find_by(app_dns: true)
-        return "#{gear.uuid}@#{fqdn(domain)}"
+        return "#{gear.uuid}@#{fqdnOrIp(domain)}"
       end
     end
     ""

